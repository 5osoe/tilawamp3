<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>فونت سكوب</title>
    
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --primary: #6366f1; --bg: #f8fafc; --card: #ffffff; --text: #1e293b; --border: #e2e8f0; --sidebar-w: 300px; }
        [data-theme="dark"] { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --border: #334155; }
        * { box-sizing: border-box; }
        body { font-family: 'IBM Plex Sans Arabic', sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        * { -webkit-tap-highlight-color: transparent; outline: none; }

        .app-container { display: flex; min-height: 100vh; }
        .sidebar {
            width: var(--sidebar-w); background: var(--card); border-left: 1px solid var(--border);
            padding: 1.2rem; display: flex; flex-direction: column; gap: 1rem;
            position: fixed; right: 0; top: 0; bottom: 0; overflow-y: auto; z-index: 1000;
        }
        .main-content { margin-right: var(--sidebar-w); flex: 1; padding: 1.5rem; }

        @media (max-width: 1024px) {
            .sidebar { position: static; width: 100%; border-left: none; }
            .app-container { flex-direction: column; }
            .main-content { margin-right: 0; }
        }

        .widget { background: var(--bg); border-radius: 12px; padding: 0.8rem; border: 1px solid var(--border); }
        .widget-label { font-size: 0.7rem; font-weight: 700; margin-bottom: 0.4rem; display: block; opacity: 0.6; }
        .btn-upload { border: 1px solid var(--primary); padding: 0.6rem; border-radius: 8px; text-align: center; cursor: pointer; color: var(--primary); font-weight: 600; font-size: 0.8rem; display: block; transition: 0.2s; background: transparent; width: 100%; }
        .btn-upload:hover { background: var(--primary); color: white; }

        .pagination { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 20px 0; padding: 10px; background: var(--card); border-radius: 12px; border: 1px solid var(--border); }
        .page-btn { background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .page-btn:disabled { background: var(--border); opacity: 0.5; cursor: not-allowed; }

        .progress-container { width: 100%; height: 6px; background: var(--border); border-radius: 10px; margin: 10px 0; display: none; overflow: hidden; }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s; }

        input { width: 100%; padding: 0.6rem; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-family: inherit; }

        .font-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
        .font-card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.2rem; display: flex; flex-direction: column; gap: 10px; position: relative; }
        .preview-text { font-size: 24px; text-align: center; padding: 1.2rem; border-radius: 12px; background: var(--bg); min-height: 100px; display: flex; align-items: center; justify-content: center; }
        .font-footer { display: flex; justify-content: space-between; align-items: center; border-top: 1px solid var(--border); padding-top: 10px; }
        .font-name { font-weight: 700; font-size: 13px; cursor: pointer; color: var(--primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 150px; }
        .user-tag { width: 90px; padding: 4px; font-size: 11px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg); color: var(--text); text-align: center; }

        /* زر حذف الخط الفردي */
        .btn-delete-font { position: absolute; top: 8px; left: 8px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; border-radius: 6px; cursor: pointer; padding: 4px; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .btn-delete-font:hover { background: #ef4444; color: white; }

        /* Print Table Styling */
        #printArea { display: none; }
        @media print {
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #000; padding: 10px; text-align: right; word-break: break-all; }
            .print-preview { font-size: 24px; }
            .sidebar, .pagination, .font-grid, #toast { display: none !important; }
        }

        #toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 0.8rem 2rem; border-radius: 50px; display: none; z-index: 2000; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 3000; }
    </style>
</head>
<body>

<div id="toast">تم النسخ</div>
<div id="loadingOverlay" class="loading-overlay">
    <h3>جاري تجهيز كافة الخطوط للتصدير...</h3>
    <p>يرجى الانتظار، قد يستغرق ذلك لحظات</p>
</div>

<div class="app-container">
    <aside class="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <b style="color:var(--primary); font-size: 1.4rem;">فونت سكوب</b>
            <button id="themeToggle" style="background:none; border:none; color:var(--text); cursor:pointer;"><i data-lucide="sun"></i></button>
        </div>

        <div class="widget">
            <div id="statsInfo" style="font-size:12px; font-weight:600;">جاري التحميل...</div>
            <button onclick="clearAll()" style="color:#ef4444; background:none; border:none; font-size:11px; cursor:pointer; margin-top:5px;">حذف كافة الخطوط</button>
        </div>

        <div class="widget">
            <span class="widget-label">إضافة خطوط</span>
            <label class="btn-upload" style="margin-bottom:8px;">رفع مجلد <input type="file" id="dirInp" webkitdirectory directory multiple hidden></label>
            <label class="btn-upload">رفع ملفات <input type="file" id="fileInp" multiple accept=".ttf,.otf,.woff2" hidden></label>
            <div class="progress-container" id="uploadProgress"><div class="progress-bar" id="progressBar"></div></div>
        </div>

        <div class="widget">
            <span class="widget-label">بحث سريع</span>
            <input type="search" id="searchBox" placeholder="اسم الخط أو الوسم...">
        </div>

        <div class="widget">
            <span class="widget-label">نص المعاينة</span>
            <input type="text" id="previewBox" placeholder="اكتب نصاً..." value="سبحان الله وبحمده">
        </div>

        <button class="btn-upload" style="background:var(--primary); color:white; border:none; margin-top: auto;" onclick="exportFullPDF()">
            <i data-lucide="file-text" style="width:16px; vertical-align:middle; margin-left:5px;"></i>
            تصدير كافة الخطوط (PDF)
        </button>
    </aside>

    <main class="main-content">
        <div id="fontGrid" class="font-grid"></div>
        <div class="pagination">
            <button class="page-btn" id="prevBtn" onclick="changePage(-1)">السابق</button>
            <span id="pageInfo">صفحة 1 من 1</span>
            <button class="page-btn" id="nextBtn" onclick="changePage(1)">التالي</button>
        </div>
    </main>
</div>

<div id="printArea">
    <table id="printTable">
        <thead>
            <tr>
                <th style="width: 45%;">المعاينة</th>
                <th style="width: 35%;">اسم الخط بالكامل</th>
                <th style="width: 20%;">الوسم</th>
            </tr>
        </thead>
        <tbody id="printTableBody"></tbody>
    </table>
</div>

<script>
    let db;
    let allFonts = [];
    let currentPage = 1;
    let exportCounter = 1;
    const itemsPerPage = 40;

    const request = indexedDB.open("FontScope_V7", 1);
    request.onupgradeneeded = e => e.target.result.createObjectStore("fonts", { keyPath: "fileName" });
    request.onsuccess = e => { db = e.target.result; loadAllData(); };

    async function loadAllData() {
        const tx = db.transaction("fonts", "readonly");
        const store = tx.objectStore("fonts");
        store.getAll().onsuccess = e => {
            allFonts = e.target.result;
            render();
        };
    }

    function render() {
        const grid = document.getElementById('fontGrid');
        const preview = document.getElementById('previewBox').value.trim();
        const query = document.getElementById('searchBox').value.toLowerCase();
        
        document.getElementById('statsInfo').innerText = `${allFonts.length} خط متاح`;
        if (!preview) { grid.innerHTML = '<center style="grid-column:1/-1; padding:50px; opacity:0.5;">اكتب نصاً للمعاينة</center>'; return; }

        const filtered = allFonts.filter(f => f.fileName.toLowerCase().includes(query) || (f.userTag || "").toLowerCase().includes(query));
        const totalPages = Math.ceil(filtered.length / itemsPerPage) || 1;
        if (currentPage > totalPages) currentPage = totalPages;
        
        document.getElementById('pageInfo').innerText = `صفحة ${currentPage} من ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage === totalPages;

        const start = (currentPage - 1) * itemsPerPage;
        const pageItems = filtered.slice(start, start + itemsPerPage);

        document.querySelectorAll('.font-style-tag').forEach(s => s.remove());
        grid.innerHTML = '';
        
        pageItems.forEach((f, i) => {
            const fontId = `f_${i}_${currentPage}`;
            const s = document.createElement('style');
            s.className = 'font-style-tag';
            s.innerHTML = `@font-face { font-family: "${fontId}"; src: url(${f.data}); font-display: swap; }`;
            document.head.appendChild(s);

            const card = document.createElement('div');
            card.className = 'font-card';
            card.innerHTML = `
                <button class="btn-delete-font" onclick="deleteFont('${f.fileName}')" title="حذف الخط">
                    <i data-lucide="trash-2" style="width:14px; height:14px;"></i>
                </button>
                <div class="preview-text" style="font-family:'${fontId}'">${preview}</div>
                <div class="font-footer">
                    <span class="font-name" onclick="copyN('${f.fileName}')">${f.fileName.split('.')[0]}</span>
                    <input type="text" class="user-tag" value="${f.userTag || ''}" onchange="updateTag('${f.fileName}', this.value)">
                </div>
            `;
            grid.appendChild(card);
        });
        lucide.createIcons();
    }

    // حذف خط واحد
    function deleteFont(fileName) {
        if(confirm(`هل تريد حذف الخط "${fileName}"؟`)) {
            const tx = db.transaction("fonts", "readwrite");
            tx.objectStore("fonts").delete(fileName);
            tx.oncomplete = () => {
                allFonts = allFonts.filter(f => f.fileName !== fileName);
                render();
            };
        }
    }

    async function exportFullPDF() {
        const overlay = document.getElementById('loadingOverlay');
        const printBody = document.getElementById('printTableBody');
        const preview = document.getElementById('previewBox').value;
        
        if (allFonts.length === 0) { alert("لا توجد خطوط لتصديرها"); return; }

        overlay.style.display = 'flex';
        printBody.innerHTML = '';
        
        document.querySelectorAll('.print-style-tag').forEach(s => s.remove());

        for (let i = 0; i < allFonts.length; i++) {
            const f = allFonts[i];
            const fontId = `exp_${i}`;
            
            const s = document.createElement('style');
            s.className = 'print-style-tag';
            s.innerHTML = `@font-face { font-family: "${fontId}"; src: url(${f.data}); }`;
            document.head.appendChild(s);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="print-preview" style="font-family:'${fontId}'">${preview}</td>
                <td style="font-weight:bold;">${f.fileName}</td>
                <td>${f.userTag || ''}</td>
            `;
            printBody.appendChild(row);

            if (i % 20 === 0) await new Promise(r => setTimeout(r, 10));
        }

        overlay.style.display = 'none';
        const originalTitle = document.title;
        document.title = `FScop ${exportCounter++}`;
        window.print();
        setTimeout(() => { document.title = originalTitle; }, 1000);
    }

    function changePage(step) { currentPage += step; window.scrollTo(0,0); render(); }

    const handleUpload = async (files) => {
        const progress = document.getElementById('uploadProgress');
        const bar = document.getElementById('progressBar');
        const validFiles = Array.from(files).filter(f => f.name.match(/\.(ttf|otf|woff2)$/i));
        if(validFiles.length === 0) return;
        progress.style.display = 'block';

        for (let i = 0; i < validFiles.length; i++) {
            const file = validFiles[i];
            await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const tx = db.transaction("fonts", "readwrite");
                    tx.objectStore("fonts").put({ fileName: file.name, data: e.target.result, userTag: '' });
                    tx.oncomplete = () => { bar.style.width = ((i + 1) / validFiles.length * 100) + '%'; resolve(); };
                };
                reader.readAsDataURL(file);
            });
        }
        setTimeout(() => { progress.style.display = 'none'; loadAllData(); }, 500);
    };

    document.getElementById('dirInp').onchange = e => handleUpload(e.target.files);
    document.getElementById('fileInp').onchange = e => handleUpload(e.target.files);
    document.getElementById('previewBox').oninput = render;
    document.getElementById('searchBox').oninput = () => { currentPage = 1; render(); };

    function updateTag(name, tag) {
        const tx = db.transaction("fonts", "readwrite");
        const store = tx.objectStore("fonts");
        store.get(name).onsuccess = e => {
            const f = e.target.result;
            if(f) { f.userTag = tag; store.put(f); }
            const idx = allFonts.findIndex(af => af.fileName === name);
            if(idx !== -1) allFonts[idx].userTag = tag;
        };
    }

    function copyN(n) {
        navigator.clipboard.writeText(n.split('.')[0]);
        const t = document.getElementById('toast');
        t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 1000);
    }

    function clearAll() {
        if(confirm('سيتم حذف كافة الخطوط، هل أنت متأكد؟')) {
            const tx = db.transaction("fonts", "readwrite");
            tx.objectStore("fonts").clear();
            tx.oncomplete = () => { allFonts = []; render(); };
        }
    }

    document.getElementById('themeToggle').onclick = () => {
        const b = document.body;
        b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        lucide.createIcons();
    };
</script>
</body>
</html>
